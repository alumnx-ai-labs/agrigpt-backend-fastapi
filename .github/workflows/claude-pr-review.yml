name: Claude Code PR Review & Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install anthropic requests

      - name: Get PR Diff
        run: git diff origin/main..HEAD > pr_diff.txt

      - name: Claude Review via API
        id: claude_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'PYEOF'
          import anthropic
          import os

          with open("pr_diff.txt", "r") as f:
              diff = f.read() or "No diff found"

          client = anthropic.Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

          message = client.messages.create(
              model="claude-opus-4-6",
              max_tokens=1024,
              messages=[
                  {
                      "role": "user",
                      "content": f"""You are a senior code reviewer for AgriGPT - a FastAPI backend for agricultural AI platform serving Indian farmers.

          Review the following PR diff and provide:
          1. Summary of changes
          2. Potential bugs or issues
          3. Security concerns
          4. Code quality feedback
          5. Final verdict

          PR Diff:
          {diff[:8000]}

          End your response with exactly one line: 'VERDICT: APPROVE' or 'VERDICT: REQUEST_CHANGES'"""
                  }
              ]
          )

          review = message.content[0].text
          print(review)

          with open("claude_review.txt", "w") as f:
              f.write(review)

          if "VERDICT: APPROVE" in review:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("verdict=APPROVE\n")
          else:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("verdict=REQUEST_CHANGES\n")
          PYEOF

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY=$(cat claude_review.txt)
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ðŸ¤– Claude Code Review

          $REVIEW_BODY"

      - name: Approve and Merge PR
        if: steps.claude_review.outputs.verdict == 'APPROVE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "âœ… Claude approved this PR."
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto

      - name: Request Changes
        if: steps.claude_review.outputs.verdict == 'REQUEST_CHANGES'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} \
            --request-changes \
            --body "âŒ Claude requested changes. Please review the comments above."